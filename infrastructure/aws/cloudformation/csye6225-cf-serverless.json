{
    "AWSTemplateFormatVersion" : "2010-09-09",
 
    "Parameters" : {
         "myBucketName":{
            "Default":"shunti.me",
            "Description": "S3 bucket name",
            "Type": "String"
         },
         "SNSNAME":{
            "Default":"arn:aws:sns:us-east-1:147432315547:reset",
            "Description": "SNS ARN for test",
            "Type": "String"
         },
         "lambdaIAMRole":{
            "Default":"role",
            "Description": "lambda IAM Role",
            "Type": "String"
         }


     },
     
     "Mappings" : {
         
         "AWSRegionArch2AMI" : {
             "us-east-1"      : { "HVM64" : "ami-9887c6e7"}        
         }          
     },
 
    "Resources" : { 

            
        "myLambda": {
            "Type": "AWS::Lambda::Function",
            
            "Properties": {
                "FunctionName":"myLambda",
                "Handler" : "Email",
                "Role": {"Ref":"lambdaIAMRole"},
                "Code": {
                    "S3Bucket": {"Fn::Join": ["", ["lambda.", {"Ref": "myBucketName" },".csye6225.com" ]]  },
                    "S3Key": "LambdaApp-2.2.jar"
                },
                "Description" : "lambda to host webapp",
                
                "Runtime": "java8",
                "Timeout": 30,
                "MemorySize":512
            }
        },
         
        "SNSTopic":{
	    
            "Type" : "AWS::SNS::Topic",
            "DependsOn" : "myLambda",
            "Properties" : {
                "TopicName" : {"Ref":"SNSNAME"},
                "Subscription":[{"Endpoint":{"Fn::GetAtt":[
                    "myLambda","Arn"
                ]},"Protocol":"lambda"
                }],
                "DisplayName":"Reset"
            }

        },

        
        "snsIAMRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName" : "snsIAMRole",
                "AssumeRolePolicyDocument": {
                    "Version" : "2012-10-17",
                    "Statement": [ {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [ "ssm.amazonaws.com" ]
                        },  
                        "Action": [ "sts:AssumeRole" ]
                    } ]
                },
                "Path": "/",
                "Policies": [ {
                    "PolicyName": "snsFullAccess",
                    "PolicyDocument": {
                        "Version": "2012-10-17",
                        "Statement": [
                        {
                            "Action": ["sns:*"],
                            "Effect": "Allow",
                            "Resource": "*"
                        }]
                    }
                }]
            }
        },
        
        "LambdaResourcePolicy": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName" : { "Ref" : "myLambda" },
              "Principal": "sns.amazonaws.com",
              "Action": "lambda:InvokeFunction",
              "SourceArn" : { "Ref" : "SNSTopic" }
            }
          }
    
    } 



} 
 
 
